rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    // 공통 함수
    // =====================================================

    // 인증된 사용자인지 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 요청 사용자 UID
    function userId() {
      return request.auth.uid;
    }

    // 가계부 문서 가져오기
    function getHousehold(householdId) {
      return get(/databases/$(database)/documents/households/$(householdId));
    }

    // 사용자가 가계부의 멤버인지 확인 (members 배열에서 확인)
    function isMember(householdId) {
      let household = getHousehold(householdId);
      return household != null &&
             household.data.members != null &&
             userId() in household.data.members.map(m => m.uid);
    }

    // 사용자가 가계부의 owner인지 확인
    function isOwner(householdId) {
      let household = getHousehold(householdId);
      return household != null &&
             household.data.members != null &&
             household.data.members.filter(m => m.uid == userId() && m.role == 'owner').size() > 0;
    }

    // 사용자가 가계부의 admin 이상인지 확인 (owner 또는 admin)
    function isAdmin(householdId) {
      let household = getHousehold(householdId);
      return household != null &&
             household.data.members != null &&
             household.data.members.filter(m => m.uid == userId() && (m.role == 'owner' || m.role == 'admin')).size() > 0;
    }

    // 사용자의 역할 가져오기
    function getMemberRole(householdId) {
      let household = getHousehold(householdId);
      let members = household.data.members.filter(m => m.uid == userId());
      return members.size() > 0 ? members[0].role : null;
    }

    // viewer가 아닌지 확인 (쓰기 권한)
    function canWrite(householdId) {
      let role = getMemberRole(householdId);
      return role != null && role != 'viewer';
    }

    // =====================================================
    // Users 컬렉션
    // /users/{userId}
    // =====================================================

    match /users/{docUserId} {
      // 본인 문서만 읽기/쓰기 가능
      allow read: if isAuthenticated() && userId() == docUserId;
      allow create: if isAuthenticated() && userId() == docUserId;
      allow update: if isAuthenticated() && userId() == docUserId;
      allow delete: if false; // 사용자 삭제는 Admin SDK에서만

      // 사용자의 환경설정
      match /preferences/{prefId} {
        allow read, write: if isAuthenticated() && userId() == docUserId;
      }
    }

    // =====================================================
    // Households 컬렉션
    // /households/{householdId}
    // =====================================================

    match /households/{householdId} {
      // 멤버만 읽기 가능
      allow read: if isAuthenticated() && isMember(householdId);

      // 새 가계부 생성 (인증된 사용자)
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == userId() &&
                       request.resource.data.members.size() > 0 &&
                       request.resource.data.members[0].uid == userId() &&
                       request.resource.data.members[0].role == 'owner';

      // owner만 가계부 정보 수정 가능
      allow update: if isAuthenticated() && isOwner(householdId);

      // owner만 가계부 삭제 가능
      allow delete: if isAuthenticated() && isOwner(householdId);

      // -------------------------------------------------
      // Transactions 서브컬렉션
      // /households/{householdId}/transactions/{transactionId}
      // -------------------------------------------------

      match /transactions/{transactionId} {
        // 멤버는 읽기 가능
        allow read: if isAuthenticated() && isMember(householdId);

        // viewer가 아닌 멤버만 생성 가능
        allow create: if isAuthenticated() &&
                         isMember(householdId) &&
                         canWrite(householdId) &&
                         request.resource.data.createdBy == userId();

        // viewer가 아닌 멤버만 수정 가능
        allow update: if isAuthenticated() &&
                         isMember(householdId) &&
                         canWrite(householdId);

        // admin 이상만 삭제 가능
        allow delete: if isAuthenticated() &&
                         isMember(householdId) &&
                         isAdmin(householdId);
      }

      // -------------------------------------------------
      // Assets 서브컬렉션
      // /households/{householdId}/assets/{assetId}
      // -------------------------------------------------

      match /assets/{assetId} {
        // 멤버는 읽기 가능
        allow read: if isAuthenticated() && isMember(householdId);

        // viewer가 아닌 멤버만 생성/수정 가능
        allow create, update: if isAuthenticated() &&
                                 isMember(householdId) &&
                                 canWrite(householdId);

        // admin 이상만 삭제 가능
        allow delete: if isAuthenticated() &&
                         isMember(householdId) &&
                         isAdmin(householdId);
      }

      // -------------------------------------------------
      // Categories 서브컬렉션
      // /households/{householdId}/categories/{categoryId}
      // -------------------------------------------------

      match /categories/{categoryId} {
        // 멤버는 읽기 가능
        allow read: if isAuthenticated() && isMember(householdId);

        // admin 이상만 생성/수정/삭제 가능
        allow create, update: if isAuthenticated() &&
                                 isMember(householdId) &&
                                 isAdmin(householdId);

        // 시스템 카테고리는 삭제 불가
        allow delete: if isAuthenticated() &&
                         isMember(householdId) &&
                         isAdmin(householdId) &&
                         resource.data.isSystem != true;
      }

      // -------------------------------------------------
      // Budgets 서브컬렉션
      // /households/{householdId}/budgets/{budgetId}
      // -------------------------------------------------

      match /budgets/{budgetId} {
        // 멤버는 읽기 가능
        allow read: if isAuthenticated() && isMember(householdId);

        // admin 이상만 예산 설정 가능
        allow create, update, delete: if isAuthenticated() &&
                                         isMember(householdId) &&
                                         isAdmin(householdId);
      }

      // -------------------------------------------------
      // Invites 서브컬렉션
      // /households/{householdId}/invites/{inviteId}
      // -------------------------------------------------

      match /invites/{inviteId} {
        // admin 이상만 초대 목록 조회 가능
        allow read: if isAuthenticated() &&
                       isMember(householdId) &&
                       isAdmin(householdId);

        // admin 이상만 초대 생성 가능
        allow create: if isAuthenticated() &&
                         isMember(householdId) &&
                         isAdmin(householdId);

        // 초대 상태 업데이트 (수락/거절)
        allow update: if isAuthenticated() && (
                         // admin이 초대 취소
                         (isMember(householdId) && isAdmin(householdId)) ||
                         // 초대받은 사용자가 수락/거절
                         (request.resource.data.email == request.auth.token.email)
                       );

        // admin 이상만 초대 삭제 가능
        allow delete: if isAuthenticated() &&
                         isMember(householdId) &&
                         isAdmin(householdId);
      }

      // -------------------------------------------------
      // Members 서브컬렉션 (비정규화된 멤버 정보)
      // /households/{householdId}/members/{memberId}
      // -------------------------------------------------

      match /members/{memberId} {
        // 멤버는 읽기 가능
        allow read: if isAuthenticated() && isMember(householdId);

        // owner만 멤버 추가/수정/삭제 가능
        allow create, update, delete: if isAuthenticated() &&
                                         isMember(householdId) &&
                                         isOwner(householdId);
      }
    }

    // =====================================================
    // 공개 초대 코드 조회용 (별도 컬렉션)
    // /inviteCodes/{inviteCode}
    // =====================================================

    match /inviteCodes/{inviteCode} {
      // 인증된 사용자는 초대 코드 조회 가능
      allow read: if isAuthenticated();

      // 생성/수정/삭제는 가계부 admin만 가능 (Cloud Functions에서 처리 권장)
      allow create, update, delete: if false;
    }
  }
}
